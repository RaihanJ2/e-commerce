import Cart from "@models/cart";
import { connectDB } from "@utils/db";
import mongoose from "mongoose";
import { getServerSession } from "next-auth";

/*{" GET CART "}*/
export const GET = async (req) => {
  try {
    await connectDB();
    const userId = await sessionId();
    const cart = await Cart.findOne({
      userId,
    }).populate("items.productId");

    if (!cart) {
      return new Response(JSON.stringify({ error: "Cart not found" }), {
        status: 404,
        headers: {
          "Content-Type": "application/json",
        },
      });
    }
    return new Response(JSON.stringify(cart), {
      status: 200,
      headers: {
        "Content-Type": "application/json",
      },
    });
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
      headers: {
        "Content-Type": "application/json",
      },
    });
  }
};

/* POST CART */

try {
  await connectDB();
  const { productId, name, size, quantity, images, price } = await req.json();
  const userId = await sessionId();

  const cart = await Cart.findOne({ userId });

  if (cart) {
    const itemIndex = cart.items.findIndex(
      (item) => item.productId.equals(productId) && item.size.equals(size)
    );

    if (itemIndex > -1) {
      cart.items[itemIndex].quantity += quantity;
    } else {
      cart.items.push({ productId, name, size, quantity, images, price });
    }
    await cart.save();
  } else {
    await Cart.create({
      userId,
      items: [
        {
          productId,
          name,
          size,
          quantity,
          images,
          price,
        },
      ],
    });
  }

  return new Response(JSON.stringify(cart), { status: 200 });
} catch (error) {
  console.error("Error in POST /api/cart:", error);
  return new Response(JSON.stringify({ error: "Internal Server Error" }), {
    status: 500,
  });
}
/* PuT CART */

export const PUT = async (req) => {
  await connectDB();
  const { productId, quantity } = await req.json();
  try {
    const cart = await Cart.findOne({
      userId: new mongoose.Types.ObjectId(userId),
    });
    if (cart) {
      const itemIndex = cart.items.findIndex(
        (item) => item.productId.toString() === productId
      );
      if (itemIndex > -1) {
        cart.items[itemIndex].quantity = quantity;
        await cart.save();
        return new Response(JSON.stringify(cart), {
          status: 200,
          headers: {
            "Content-Type": "application/json",
          },
        });
      }
    }
    return new Response("Cart or item not found", {
      status: 404,
      headers: {
        "Content-Type": "application/json",
      },
    });
  } catch (error) {
    return new Response("Failed to update item quantity", {
      status: 500,
      headers: {
        "Content-Type": "application/json",
      },
    });
  }
};

/* DELETE CART */

export const DELETE = async (req) => {
  await connectDB();
  const { productId } = await req.json();
  try {
    const userId = await sessionId(req);
    const cart = await Cart.findOne({
      userId: new mongoose.Types.ObjectId(userId),
    });
    if (cart) {
      cart.items = cart.items.filter(
        (item) => item.productId.toString() !== productId
      );
      await cart.save();
      return new Response(JSON.stringify(cart), {
        status: 200,
        headers: {
          "Content-Type": "application/json",
        },
      });
    }
    return new Response("Cart or item not found", {
      status: 404,
      headers: {
        "Content-Type": "application/json",
      },
    });
  } catch (error) {
    return new Response("Failed to remove item from cart", {
      status: 500,
      headers: {
        "Content-Type": "application/json",
      },
    });
  }
};
